# Clear workspace and graphics
rm(list = ls())
graphics.off()

library(sf)
library(terra)

# ===============================================================================
# set important variables
base_path <- getwd()

file_name <- 'ang20190712t231624_rfl_v2v2_img'

boundary_file_path <- paste0(base_path, '/cutline/crop_large/crop_large.shp')
raw_image_file_path <- paste0(base_path, '/data/hs_raw_image/', file_name)
rectified_image_file_path <- paste0(base_path, '/data/rectified/', file_name, '_rectified')
rectified_hdr_file_path <- paste0(rectified_image_file_path, '.hdr')

target_srs <- "EPSG:32604"  # Define target CRS

# Construct the gdalwarp command for rectification and reprojection
gdal_command_cutline <- sprintf(
  #"gdalwarp -of ENVI -t_srs %s -co INTERLEAVE=BIL %s %s",
  "gdalwarp -of ENVI -co INTERLEAVE=BIL -srcnodata -9999 -dstnodata 0 -cutline %s -crop_to_cutline %s %s",
  boundary_file_path,
  raw_image_file_path,
  rectified_image_file_path
)

gdal_command_rectify <- sprintf(
  "gdalwarp -of ENVI -co INTERLEAVE=BIL -srcnodata -9999 -dstnodata 0 %s %s",
  raw_image_file_path,
  rectified_image_file_path
)

# Print the command to check if it's correctly formed
# print(gdal_command)

# Execute the command in R
system(gdal_command_rectify)


# ===============================================================================
# Define wavelength information to add to .hdr file
wavelength_values <- c(
  376.719576 ,
  381.729576 ,
  386.739576 ,
  391.749576 ,
  396.749576 ,
  401.759576 ,
  406.76957600000003 ,
  411.77957599999996 ,
  416.789576 ,
  421.799576,
  426.80957600000005 ,
  431.819576 ,
  436.819576 ,
  441.829576 ,
  446.839576 ,
  451.84957599999996 ,
  456.859576 ,
  461.869576 ,
  466.87957600000004 ,
  471.87957600000004 ,
  476.889576 ,
  481.899576 ,
  486.909576 ,
  491.919576 ,
  496.929576 ,
  501.93957600000005 ,
  506.94957600000004 ,
  511.94957600000004 ,
  516.959576 ,
  521.9695760000001 ,
  526.979576 ,
  531.9895759999999 ,
  536.999576 ,
  542.009576 ,
  547.009576 ,
  552.0195759999999 ,
  557.029576 ,
  562.039576 ,
  567.049576 ,
  572.059576 ,
  577.069576 ,
  582.0795760000001 ,
  587.0795760000001 ,
  592.089576 ,
  597.099576 ,
  602.1095760000001 ,
  607.1195759999999 ,
  612.1295759999999 ,
  617.139576 ,
  622.139576 ,
  627.149576 ,
  632.1595759999999 ,
  637.169576 ,
  642.179576 ,
  647.189576 ,
  652.199576 ,
  657.209576 ,
  662.209576 ,
  667.2195760000001 ,
  672.229576 ,
  677.2395759999999 ,
  682.249576 ,
  687.259576 ,
  692.269576 ,
  697.2695759999999 ,
  702.279576 ,
  707.289576 ,
  712.299576 ,
  717.309576 ,
  722.319576 ,
  727.3295760000001 ,
  732.339576 ,
  737.339576 ,
  742.349576 ,
  747.3595760000001 ,
  752.3695759999999 ,
  757.379576 ,
  762.389576 ,
  767.399576 ,
  772.399576 ,
  777.409576 ,
  782.419576 ,
  787.429576 ,
  792.439576 ,
  797.449576 ,
  802.459576 ,
  807.4695760000001 ,
  812.4695760000001 ,
  817.479576 ,
  822.4895759999999 ,
  827.499576 ,
  832.5095759999999 ,
  837.519576 ,
  842.529576 ,
  847.529576 ,
  852.539576 ,
  857.549576 ,
  862.559576 ,
  867.569576 ,
  872.579576 ,
  877.589576 ,
  882.5995760000001 ,
  887.599576 ,
  892.6095760000001 ,
  897.6195759999999 ,
  902.629576 ,
  907.639576 ,
  912.6495759999999 ,
  917.659576 ,
  922.669576 ,
  927.669576 ,
  932.679576 ,
  937.689576 ,
  942.699576 ,
  947.7095760000001 ,
  952.719576 ,
  957.729576 ,
  962.729576 ,
  967.739576 ,
  972.749576 ,
  977.7595759999999 ,
  982.769576 ,
  987.779576 ,
  992.7895759999999 ,
  997.799576 ,
  1002.7995759999999 ,
  1007.8095760000001 ,
  1012.8195760000001 ,
  1017.829576 ,
  1022.839576 ,
  1027.8495759999998 ,
  1032.8595759999998 ,
  1037.859576 ,
  1042.869576 ,
  1047.8795759999998 ,
  1052.889576 ,
  1057.899576 ,
  1062.909576 ,
  1067.919576 ,
  1072.929576 ,
  1077.929576 ,
  1082.939576 ,
  1087.949576 ,
  1092.959576 ,
  1097.969576 ,
  1102.9795760000002 ,
  1107.989576 ,
  1112.989576 ,
  1117.9995760000002 ,
  1123.0095760000002 ,
  1128.019576 ,
  1133.029576 ,
  1138.039576 ,
  1143.049576 ,
  1148.059576 ,
  1153.0595759999999 ,
  1158.0695759999999 ,
  1163.0795759999999 ,
  1168.089576 ,
  1173.099576 ,
  1178.109576 ,
  1183.119576 ,
  1188.119576 ,
  1193.129576 ,
  1198.139576 ,
  1203.149576 ,
  1208.159576 ,
  1213.169576 ,
  1218.179576 ,
  1223.189576 ,
  1228.189576 ,
  1233.199576 ,
  1238.209576 ,
  1243.219576 ,
  1248.229576 ,
  1253.239576 ,
  1258.2495760000002 ,
  1263.249576 ,
  1268.259576 ,
  1273.269576 ,
  1278.2795760000001 ,
  1283.2895760000001 ,
  1288.299576 ,
  1293.3095759999999 ,
  1298.3195759999999 ,
  1303.319576 ,
  1308.329576 ,
  1313.3395759999999 ,
  1318.3495759999998 ,
  1323.359576 ,
  1328.369576 ,
  1333.379576 ,
  1338.3795759999998 ,
  1343.389576 ,
  1348.399576 ,
  1353.409576 ,
  1358.419576 ,
  1363.429576 ,
  1368.4395760000002 ,
  1373.449576 ,
  1378.449576 ,
  1383.459576 ,
  1388.4695760000002 ,
  1393.479576 ,
  1398.489576 ,
  1403.499576 ,
  1408.509576 ,
  1413.5095760000002 ,
  1418.519576 ,
  1423.529576 ,
  1428.539576 ,
  1433.5495760000001 ,
  1438.559576 ,
  1443.569576 ,
  1448.579576 ,
  1453.579576 ,
  1458.589576 ,
  1463.599576 ,
  1468.609576 ,
  1473.6195759999998 ,
  1478.6295759999998 ,
  1483.639576 ,
  1488.639576 ,
  1493.649576 ,
  1498.659576 ,
  1503.669576 ,
  1508.679576 ,
  1513.689576 ,
  1518.699576 ,
  1523.709576 ,
  1528.709576 ,
  1533.719576 ,
  1538.729576 ,
  1543.739576 ,
  1548.7495760000002 ,
  1553.759576 ,
  1558.769576 ,
  1563.7695760000001 ,
  1568.7795760000001 ,
  1573.7895760000001 ,
  1578.799576 ,
  1583.8095759999999 ,
  1588.8195759999999 ,
  1593.829576 ,
  1598.839576 ,
  1603.8395759999999 ,
  1608.8495759999998 ,
  1613.859576 ,
  1618.869576 ,
  1623.879576 ,
  1628.889576 ,
  1633.8995759999998 ,
  1638.899576 ,
  1643.909576 ,
  1648.919576 ,
  1653.929576 ,
  1658.939576 ,
  1663.949576 ,
  1668.959576 ,
  1673.969576 ,
  1678.969576 ,
  1683.979576 ,
  1688.989576 ,
  1693.999576 ,
  1699.009576 ,
  1704.0195760000001 ,
  1709.0295760000001 ,
  1714.029576 ,
  1719.039576 ,
  1724.0495760000001 ,
  1729.059576 ,
  1734.069576 ,
  1739.0795759999999 ,
  1744.0895759999999 ,
  1749.099576 ,
  1754.099576 ,
  1759.109576 ,
  1764.1195759999998 ,
  1769.129576 ,
  1774.139576 ,
  1779.149576 ,
  1784.159576 ,
  1789.159576 ,
  1794.169576 ,
  1799.179576 ,
  1804.189576 ,
  1809.199576 ,
  1814.2095760000002 ,
  1819.219576 ,
  1824.229576 ,
  1829.229576 ,
  1834.2395760000002 ,
  1839.2495760000002 ,
  1844.259576 ,
  1849.269576 ,
  1854.279576 ,
  1859.2895760000001 ,
  1864.2995760000001 ,
  1869.299576 ,
  1874.3095759999999 ,
  1879.319576 ,
  1884.329576 ,
  1889.339576 ,
  1894.349576 ,
  1899.3595759999998 ,
  1904.359576 ,
  1909.369576 ,
  1914.379576 ,
  1919.389576 ,
  1924.3995759999998 ,
  1929.409576 ,
  1934.419576 ,
  1939.429576 ,
  1944.429576 ,
  1949.439576 ,
  1954.449576 ,
  1959.459576 ,
  1964.469576 ,
  1969.479576 ,
  1974.4895760000002 ,
  1979.489576 ,
  1984.499576 ,
  1989.509576 ,
  1994.5195760000001 ,
  1999.5295760000001 ,
  2004.539576 ,
  2009.549576 ,
  2014.5595759999999 ,
  2019.5595759999999 ,
  2024.569576 ,
  2029.579576 ,
  2034.589576 ,
  2039.599576 ,
  2044.609576 ,
  2049.619576 ,
  2054.619576 ,
  2059.629576 ,
  2064.639576 ,
  2069.6495760000003 ,
  2074.659576 ,
  2079.6695760000002 ,
  2084.679576 ,
  2089.689576 ,
  2094.6895759999998 ,
  2099.699576 ,
  2104.7095759999997 ,
  2109.719576 ,
  2114.729576 ,
  2119.7395760000004 ,
  2124.749576 ,
  2129.749576 ,
  2134.759576 ,
  2139.769576 ,
  2144.779576 ,
  2149.7895759999997 ,
  2154.799576 ,
  2159.8095759999997 ,
  2164.8195760000003 ,
  2169.819576 ,
  2174.829576 ,
  2179.839576 ,
  2184.849576 ,
  2189.859576 ,
  2194.869576 ,
  2199.879576 ,
  2204.8795760000003 ,
  2209.889576 ,
  2214.8995760000003 ,
  2219.909576 ,
  2224.9195760000002 ,
  2229.929576 ,
  2234.9395759999998 ,
  2239.949576 ,
  2244.949576 ,
  2249.959576 ,
  2254.969576 ,
  2259.979576 ,
  2264.989576 ,
  2269.999576 ,
  2275.009576 ,
  2280.009576 ,
  2285.0195759999997 ,
  2290.029576 ,
  2295.039576 ,
  2300.0495760000003 ,
  2305.059576 ,
  2310.069576 ,
  2315.079576 ,
  2320.079576 ,
  2325.089576 ,
  2330.0995759999996 ,
  2335.109576 ,
  2340.119576 ,
  2345.1295760000003 ,
  2350.139576 ,
  2355.139576 ,
  2360.149576 ,
  2365.159576 ,
  2370.169576 ,
  2375.179576 ,
  2380.1895759999998 ,
  2385.1995760000004 ,
  2390.209576 ,
  2395.209576 ,
  2400.219576 ,
  2405.229576 ,
  2410.239576 ,
  2415.2495759999997 ,
  2420.259576 ,
  2425.2695759999997 ,
  2430.269576 ,
  2435.279576 ,
  2440.289576 ,
  2445.299576 ,
  2450.309576 ,
  2455.319576 ,
  2460.329576 ,
  2465.339576 ,
  2470.3395760000003 ,
  2475.349576 ,
  2480.3595760000003 ,
  2485.369576 ,
  2490.379576 ,
  2495.389576 ,
  2500.399576
)


wavelength_units <- "Nanometers"
wavelength_line <- paste("wavelength = {", paste(wavelength_values, collapse = " , "), "}")
units_line <- paste("wavelength units =", wavelength_units)

# ===============================================================================
# Append wavelength information to the .hdr file
if (file.exists(rectified_hdr_file_path)) {
  # Read the existing content of the .hdr file
  hdr_content <- readLines(rectified_hdr_file_path)

  # Append the wavelength information at the end of the file
  hdr_content <- c(hdr_content, units_line, wavelength_line)

  # Write the updated content back to the .hdr file
  writeLines(hdr_content, rectified_hdr_file_path)

  cat("Wavelength information successfully added to the .hdr file.\n")
} else {
  cat("Error: The .hdr file does not exist. Check the file path.\n")
}

# # Rectification of the flight strip
# sf::gdal_utils("warp",
#                source = raw_image_file_path,
#                destination = rectified_image_file_path,
#                options = c(
#                  "-of", "ENVI",               # Output format (ENVI)
#                  "-t_srs", target_srs,      # Target CRS
#                  "-cutline", boundary_file_path, # Path to shapefile for cutline
#                  "-crop_to_cutline",          # Crop to the cutline shape
#                  "-co", "INTERLEAVE=BIL"      # Add BIL interleave option
#                )
# )
#
#
# boundary_file_path <- "cutline/output_rectangle_subzone_d/output_rectangle.shp"
# raw_image_file_path <- "data/hs_raw_image/ang20190712t231624_rfl_v2v2_img"
# rectified_image_file_path <- "data/rectified/ang20190712t231624_rfl_v2v2_img_rectified_V2"
#
# target_srs <- "EPSG:32613"  # Define target CRS
#
# # Rectification of the flight strip
# sf::gdal_utils("warp",
#                source = raw_image_file_path,
#                destination = rectified_image_file_path,
#                options = c(
#                  "-of", "ENVI",               # Output format (ENVI)
#                  "-t_srs", target_srs,      # Target CRS
#                  "-co", "INTERLEAVE=BIL"      # Add BIL interleave option
#                )
# )
